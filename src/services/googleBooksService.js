// ===== SERVICIO COMPLETO PARA GOOGLE BOOKS INTEGRATION =====
// Este servicio maneja toda la integraci√≥n con Google Books API a trav√©s de tu backend

import api from "./api";

export const googleBooksService = {
  // ===== B√öSQUEDA EN GOOGLE BOOKS =====

  // B√∫squeda b√°sica en Google Books
  search: async (query, maxResults = 20, startIndex = 0) => {
    try {
      console.log(`üåê Buscando en Google Books: "${query}"`);
      const response = await api.get("/books/search-external", {
        params: {
          q: query,
          maxResults,
          startIndex,
        },
      });
      console.log("‚úÖ Resultados Google Books:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error b√∫squeda Google Books:", error);
      throw error;
    }
  },

  // B√∫squeda avanzada con filtros espec√≠ficos
  advancedSearch: async (searchParams) => {
    try {
      console.log("üîç B√∫squeda avanzada Google Books:", searchParams);
      const response = await api.get("/books/search-external-advanced", {
        params: searchParams,
      });
      console.log("‚úÖ Resultados b√∫squeda avanzada:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error b√∫squeda avanzada:", error);
      throw error;
    }
  },

  // Buscar por ISBN espec√≠fico
  searchByISBN: async (isbn) => {
    try {
      console.log(`üìö Buscando por ISBN: ${isbn}`);
      const response = await api.get(`/books/search-external?q=isbn:${isbn}`);
      console.log("‚úÖ Resultado por ISBN:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error b√∫squeda por ISBN:", error);
      throw error;
    }
  },

  // Buscar por t√≠tulo exacto
  searchByTitle: async (title, author = null) => {
    try {
      let query = `intitle:"${title}"`;
      if (author) {
        query += ` inauthor:"${author}"`;
      }
      console.log(
        `üìñ Buscando t√≠tulo exacto: ${title}${author ? ` por ${author}` : ""}`
      );
      const response = await api.get("/books/search-external", {
        params: { q: query, maxResults: 10 },
      });
      console.log("‚úÖ Resultados por t√≠tulo:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error b√∫squeda por t√≠tulo:", error);
      throw error;
    }
  },

  // Buscar por autor
  searchByAuthor: async (author, maxResults = 40) => {
    try {
      console.log(`üë®‚Äçüíº Buscando libros de: ${author}`);
      const response = await api.get("/books/search-external", {
        params: {
          q: `inauthor:"${author}"`,
          maxResults,
        },
      });
      console.log("‚úÖ Libros del autor:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error b√∫squeda por autor:", error);
      throw error;
    }
  },

  // ===== IMPORTACI√ìN Y ENRIQUECIMIENTO =====

  // Importar libro completo desde Google Books
  importBook: async (googleBookId, additionalData = {}) => {
    try {
      console.log(`üì• Importando libro desde Google Books: ${googleBookId}`);
      const response = await api.post("/books/import-google", {
        googleBookId,
        ...additionalData,
      });
      console.log("‚úÖ Libro importado:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error importando libro:", error);
      throw error;
    }
  },

  // Importar desde datos completos de Google Books
  importFromData: async (googleBookData, userPreferences = {}) => {
    try {
      console.log(
        "üì• Importando desde datos completos...",
        googleBookData.volumeInfo?.title
      );
      const response = await api.post("/books/import-google", {
        googleBookData,
        userPreferences,
      });
      console.log("‚úÖ Libro importado desde datos:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error importando desde datos:", error);
      throw error;
    }
  },

  // Enriquecer libro existente con datos de Google Books
  enrichExistingBook: async (bookId, googleBookData = null) => {
    try {
      console.log(`‚ú® Enriqueciendo libro ${bookId} con datos de Google...`);
      const payload = googleBookData ? { googleBookData } : {};
      const response = await api.patch(
        `/books/${bookId}/enrich-google`,
        payload
      );
      console.log("‚úÖ Libro enriquecido:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error enriqueciendo libro:", error);
      throw error;
    }
  },

  // ===== B√öSQUEDA H√çBRIDA =====

  // B√∫squeda h√≠brida (local + Google Books)
  hybridSearch: async (query, options = {}) => {
    try {
      const {
        includeExternal = true,
        maxResults = 20,
        prioritizeLocal = true,
      } = options;

      console.log(`üîçüåê B√∫squeda h√≠brida: "${query}"`);
      const response = await api.get("/books/search-hybrid", {
        params: {
          q: query,
          includeExternal,
          maxResults,
          prioritizeLocal,
        },
      });
      console.log("‚úÖ Resultados h√≠bridos:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error b√∫squeda h√≠brida:", error);
      throw error;
    }
  },

  // ===== AUTOCOMPLETADO Y SUGERENCIAS =====

  // Autocompletado inteligente para formularios
  getAutocomplete: async (query, field = "all") => {
    try {
      console.log(`ü§ñ Autocompletado para "${query}" en campo: ${field}`);
      const response = await api.get("/books/autocomplete", {
        params: { q: query, field },
      });
      console.log("‚úÖ Sugerencias autocompletado:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error autocompletado:", error);
      throw error;
    }
  },

  // Sugerencias para crear nuevo libro
  getSuggestions: async (title, author = null) => {
    try {
      console.log(
        `üí° Obteniendo sugerencias para: "${title}"${
          author ? ` por ${author}` : ""
        }`
      );
      const response = await api.get("/books/suggestions", {
        params: { title, author },
      });
      console.log("‚úÖ Sugerencias obtenidas:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error obteniendo sugerencias:", error);
      throw error;
    }
  },

  // ===== UTILIDADES Y HELPERS =====

  // Obtener detalles completos de un libro por Google Books ID
  getBookDetails: async (googleBookId) => {
    try {
      console.log(`üìñ Obteniendo detalles completos: ${googleBookId}`);
      const response = await api.get(`/google-books/details/${googleBookId}`);
      console.log("‚úÖ Detalles completos:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error obteniendo detalles:", error);
      throw error;
    }
  },

  // Verificar disponibilidad de un libro
  checkAvailability: async (isbn) => {
    try {
      console.log(`üîç Verificando disponibilidad: ${isbn}`);
      const response = await api.get("/google-books/availability", {
        params: { isbn },
      });
      console.log("‚úÖ Estado disponibilidad:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error verificando disponibilidad:", error);
      throw error;
    }
  },

  // Obtener libros relacionados/similares
  getRelatedBooks: async (googleBookId, maxResults = 10) => {
    try {
      console.log(`üîó Obteniendo libros relacionados: ${googleBookId}`);
      const response = await api.get("/google-books/related", {
        params: { bookId: googleBookId, maxResults },
      });
      console.log("‚úÖ Libros relacionados:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error libros relacionados:", error);
      throw error;
    }
  },

  // ===== DETECCI√ìN DE DUPLICADOS =====

  // Verificar si libro ya existe en biblioteca
  checkDuplicate: async (googleBookData) => {
    try {
      console.log(
        "üîç Verificando duplicados...",
        googleBookData.volumeInfo?.title
      );
      const response = await api.post("/books/check-duplicate", {
        googleBookData,
      });
      console.log("‚úÖ Verificaci√≥n duplicados:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error verificando duplicados:", error);
      throw error;
    }
  },

  // Encontrar posibles duplicados por t√≠tulo y autor
  findPotentialDuplicates: async (title, author) => {
    try {
      console.log(
        `üîç Buscando duplicados potenciales: "${title}" por ${author}`
      );
      const response = await api.get("/books/find-duplicates", {
        params: { title, author },
      });
      console.log("‚úÖ Duplicados potenciales:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error buscando duplicados:", error);
      throw error;
    }
  },

  // ===== BATCH OPERATIONS =====

  // Importar m√∫ltiples libros en lote
  batchImport: async (googleBookIds, preferences = {}) => {
    try {
      console.log("üì¶ Importaci√≥n en lote:", googleBookIds);
      const response = await api.post("/books/batch-import-google", {
        bookIds: googleBookIds,
        preferences,
      });
      console.log("‚úÖ Importaci√≥n lote completada:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error importaci√≥n lote:", error);
      throw error;
    }
  },

  // Enriquecer m√∫ltiples libros existentes
  batchEnrich: async (bookIds) => {
    try {
      console.log("‚ú® Enriquecimiento en lote:", bookIds);
      const response = await api.post("/books/batch-enrich-google", {
        bookIds,
      });
      console.log("‚úÖ Enriquecimiento lote completado:", response.data);
      return response;
    } catch (error) {
      console.error("‚ùå Error enriquecimiento lote:", error);
      throw error;
    }
  },

  // ===== CONFIGURACI√ìN Y CACHE =====

  // Configurar preferencias de importaci√≥n
  setImportPreferences: async (preferences) => {
    try {
      console.log("‚öôÔ∏è Configurando preferencias importaci√≥n:", preferences);
      const response = await api.post("/google-books/preferences", preferences);
      console.log("‚úÖ Preferencias guardadas");
      return response;
    } catch (error) {
      console.error("‚ùå Error guardando preferencias:", error);
      throw error;
    }
  },

  // Limpiar cach√© de b√∫squedas de Google Books
  clearSearchCache: async () => {
    try {
      console.log("üßπ Limpiando cach√© Google Books...");
      const response = await api.delete("/google-books/cache");
      console.log("‚úÖ Cach√© limpiado");
      return response;
    } catch (error) {
      console.error("‚ùå Error limpiando cach√©:", error);
      throw error;
    }
  },

  // ===== HELPERS PARA UI =====

  // Formatear datos de Google Books para UI
  formatBookForUI: (googleBookData) => {
    const book = googleBookData.volumeInfo || {};
    return {
      id: googleBookData.id,
      title: book.title || "Sin t√≠tulo",
      subtitle: book.subtitle || "",
      authors: book.authors || ["Autor desconocido"],
      publisher: book.publisher || "Editorial desconocida",
      publishedDate: book.publishedDate || "",
      description: book.description || "Sin descripci√≥n",
      isbn:
        book.industryIdentifiers?.find((id) => id.type === "ISBN_13")
          ?.identifier || "",
      pageCount: book.pageCount || 0,
      categories: book.categories || [],
      averageRating: book.averageRating || 0,
      ratingsCount: book.ratingsCount || 0,
      thumbnail: book.imageLinks?.thumbnail || "",
      smallThumbnail: book.imageLinks?.smallThumbnail || "",
      previewLink: book.previewLink || "",
      infoLink: book.infoLink || "",
      language: book.language || "es",
    };
  },

  // Validar datos m√≠nimos requeridos
  validateBookData: (googleBookData) => {
    const book = googleBookData.volumeInfo || {};
    const errors = [];

    if (!book.title) errors.push("T√≠tulo requerido");
    if (!book.authors || book.authors.length === 0)
      errors.push("Al menos un autor requerido");

    return {
      isValid: errors.length === 0,
      errors,
    };
  },
};
